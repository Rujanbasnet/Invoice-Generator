<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices - InvoiceGen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="./auth-improved.js"></script>
    <script src="./js/dataStore.js"></script>
    <script src="./js/pdfGenerator.js"></script>
    <script src="./js/modalSystem.js"></script>
    <script src="./js/paymentManager.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .invoice-row:hover { background-color: #f8fafc; }
        .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; text-transform: capitalize; }
        .status-paid { background-color: #dcfce7; color: #166534; }
        .status-sent { background-color: #dbeafe; color: #1e40af; }
        .status-overdue { background-color: #fee2e2; color: #991b1b; }
        .status-draft { background-color: #e5e7eb; color: #374151; }
        .user-menu { transform: translateY(-10px); opacity: 0; pointer-events: none; transition: all 0.2s ease; }
        .user-menu.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .action-btn { transition: all 0.2s ease; }
        .action-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-gray-900">InvoiceGen</h1>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="nav-link text-gray-600 hover:text-gray-900">Dashboard</a>
                    <a href="invoices.html" class="nav-link text-blue-600 font-medium">Invoices</a>
                    <a href="clients.html" class="nav-link text-gray-600 hover:text-gray-900">Clients</a>
                    <a href="invoice-design.html" class="nav-link text-gray-600 hover:text-gray-900">Invoice Design</a>
                    <a href="settings.html" class="nav-link text-gray-600 hover:text-gray-900">Settings</a>
                </div>
                <div class="relative">
                    <button id="user-menu-button" class="flex items-center space-x-3 text-gray-700 hover:text-gray-900 focus:outline-none">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">TU</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Invoice Management</h1>
                <p class="text-gray-600 mt-1">Oversee all your invoices and track their status.</p>
            </div>
            <button onclick="createInvoice()" class="mt-4 md:mt-0 bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center">
                <i class="fas fa-plus mr-2"></i>Create New Invoice
            </button>
        </header>

        <!-- Stats Cards -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-sm font-medium text-gray-500">Total Outstanding</h3>
                <p id="stat-outstanding" class="text-2xl font-semibold text-gray-900 mt-1">$0.00</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-sm font-medium text-gray-500">Overdue</h3>
                <p id="stat-overdue" class="text-2xl font-semibold text-red-600 mt-1">$0.00</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-sm font-medium text-gray-500">Paid (Last 30 days)</h3>
                <p id="stat-paid" class="text-2xl font-semibold text-green-600 mt-1">$0.00</p>
            </div>
        </section>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <!-- Filters -->
            <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-1/2">
                    <input type="text" id="search-input" placeholder="Search by invoice #, client name..." class="w-full border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex gap-4">
                    <select id="status-filter" class="border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="sent">Sent</option>
                        <option value="overdue">Overdue</option>
                        <option value="draft">Draft</option>
                    </select>
                    <select id="sort-filter" class="border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="date_desc">Newest First</option>
                        <option value="date_asc">Oldest First</option>
                        <option value="amount_desc">Amount (High-Low)</option>
                        <option value="amount_asc">Amount (Low-High)</option>
                    </select>
                </div>
            </div>

            <!-- Invoices Table -->
            <div id="table-container" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="invoice-table-body">
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-16">
                 <i class="fas fa-file-invoice text-5xl text-gray-300"></i>
                 <h3 class="mt-4 text-lg font-medium text-gray-900">No invoices found</h3>
                 <p class="mt-1 text-sm text-gray-500">Get started by creating your first invoice.</p>
                 <div class="mt-6">
                    <button onclick="createInvoice()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center mx-auto">
                        <i class="fas fa-plus mr-2"></i>Create First Invoice
                    </button>
                 </div>
            </div>

            <!-- Pagination -->
            <div id="pagination-controls" class="p-4 border-t border-gray-200 flex justify-between items-center">
                <button id="prev-page" class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <span id="page-info" class="text-sm text-gray-700">Page 1 of 1</span>
                <button id="next-page" class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            </div>
        </div>
    </div>

    <script>
        let dataStore, modalSystem;
        let allInvoices = [];
        let filteredInvoices = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', function() {
            dataStore = new DataStore();
            modalSystem = new ModalSystem();
            initializeInvoicesPage();
        });

        function initializeInvoicesPage() {
            setupEventListeners();
            loadInvoiceData();
            
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get('filter');
            if (filter) {
                document.getElementById('status-filter').value = filter;
            }
            applyFiltersAndSort();
        }
        
        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);
            document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sort-filter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('prev-page').addEventListener('click', () => changePage(-1));
            document.getElementById('next-page').addEventListener('click', () => changePage(1));
        }

        function loadInvoiceData() {
            allInvoices = dataStore.getInvoices();
            updateStats();
        }

        function updateStats() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

            let outstanding = 0;
            let overdue = 0;
            let paidLast30Days = 0;

            allInvoices.forEach(inv => {
                if (inv.status === 'sent') {
                    outstanding += inv.total || 0;
                } else if (inv.status === 'overdue') {
                    outstanding += inv.total || 0;
                    overdue += inv.total || 0;
                } else if (inv.status === 'paid' && new Date(inv.date) >= thirtyDaysAgo) {
                    paidLast30Days += inv.total || 0;
                }
            });

            document.getElementById('stat-outstanding').textContent = `$${outstanding.toFixed(2)}`;
            document.getElementById('stat-overdue').textContent = `$${overdue.toFixed(2)}`;
            document.getElementById('stat-paid').textContent = `$${paidLast30Days.toFixed(2)}`;
        }
        
        function applyFiltersAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const sortBy = document.getElementById('sort-filter').value;

            filteredInvoices = allInvoices.filter(invoice => {
                const client = dataStore.getClient(invoice.clientId) || {};
                const searchableText = `${invoice.number} ${client.name}`.toLowerCase();
                
                const matchesSearch = searchTerm ? searchableText.includes(searchTerm) : true;
                const matchesStatus = statusFilter ? invoice.status === statusFilter : true;
                
                return matchesSearch && matchesStatus;
            });

            filteredInvoices.sort((a, b) => {
                switch (sortBy) {
                    case 'date_asc': return new Date(a.date) - new Date(b.date);
                    case 'amount_desc': return (b.total || 0) - (a.total || 0);
                    case 'amount_asc': return (a.total || 0) - (b.total || 0);
                    case 'date_desc':
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            currentPage = 1;
            renderPage();
        }

        function renderPage() {
            const emptyState = document.getElementById('empty-state');
            const tableContainer = document.getElementById('table-container');
            const paginationControls = document.getElementById('pagination-controls');
            const tbody = document.getElementById('invoice-table-body');
            
            if (filteredInvoices.length === 0) {
                emptyState.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                paginationControls.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            paginationControls.classList.remove('hidden');

            const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
            const pageInfo = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredInvoices.slice(startIndex, endIndex);

            tbody.innerHTML = pageItems.map(invoice => {
                const client = dataStore.getClient(invoice.clientId) || { id: 'unknown', name: 'Unknown Client' };
                const initials = client.name.split(' ').map(n=>n[0]).join('').toUpperCase();
                const avatarColor = getAvatarColor(client.id);

                return `
                    <tr class="invoice-row">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full ${avatarColor} flex items-center justify-center">
                                    <span class="text-white font-medium">${initials}</span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${client.name}</div>
                                    <div class="text-sm text-gray-500">${client.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${invoice.number}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">$${(invoice.total || 0).toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>Issued: ${formatDate(invoice.date)}</div>
                            <div>Due: ${formatDate(invoice.dueDate)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-badge ${getStatusBadgeClass(invoice.status)}">${invoice.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end items-center space-x-3">
                                <button onclick="viewInvoice('${invoice.id}')" title="View" class="action-btn text-gray-400 hover:text-blue-600"><i class="fas fa-eye"></i></button>
                                <button onclick="editInvoice('${invoice.id}')" title="Edit" class="action-btn text-gray-400 hover:text-green-600"><i class="fas fa-pencil-alt"></i></button>
                                <button onclick="downloadInvoice('${invoice.id}')" title="Download" class="action-btn text-gray-400 hover:text-indigo-600"><i class="fas fa-download"></i></button>
                                <button onclick="deleteInvoice('${invoice.id}')" title="Delete" class="action-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        }

        function changePage(direction) {
            currentPage += direction;
            renderPage();
        }

        function getStatusBadgeClass(status) {
            return `status-${status}`;
        }
        
        function getAvatarColor(id) {
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 'bg-yellow-500', 'bg-indigo-500'];
            const hash = id.split('').reduce((acc, char) => char.charCodeAt(0) + ((acc << 5) - acc), 0);
            return colors[Math.abs(hash) % colors.length];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function createInvoice() {
            window.location.href = 'create-invoice.html';
        }
        
        function viewInvoice(id) { alert(`Viewing invoice: ${id}`); }
        function editInvoice(id) { window.location.href = `create-invoice.html?id=${id}`; }
        function downloadInvoice(id) { alert(`Downloading PDF for invoice: ${id}`); }
        function deleteInvoice(id) { 
            if(confirm('Are you sure you want to delete this invoice?')) {
                alert(`Deleting invoice: ${id}`);
                // dataStore.deleteInvoice(id); // Future implementation
                // loadInvoiceData();
                // applyFiltersAndSort();
            }
        }

    </script>
</body>
</html>

